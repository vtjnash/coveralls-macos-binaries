name: Build and Release Coveralls macOS Binary

on:
  workflow_dispatch:
    inputs:
      upstream_version:
        description: 'Upstream Coveralls version to build (e.g., v0.6.15)'
        required: true
        type: string

env:
  CRYSTAL_VERSION: "1.17.1"
  OPENSSL_VERSION: "3.5.2"

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-latest
            arch: aarch64
            artifact_suffix: aarch64
          - runner: macos-13
            arch: x86_64
            artifact_suffix: x86_64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Install Homebrew dependencies
        run: |
          # Install Crystal (includes shards) and pkg-config from Homebrew
          brew install crystal pkg-config

      - name: Download and Extract Crystal Compiler
        run: |
          # Download Crystal ${{ env.CRYSTAL_VERSION }} tarball
          curl -L -o crystal-${{ env.CRYSTAL_VERSION }}-1-darwin-universal.tar.gz \
            https://github.com/crystal-lang/crystal/releases/download/${{ env.CRYSTAL_VERSION }}/crystal-${{ env.CRYSTAL_VERSION }}-1-darwin-universal.tar.gz

          # Extract to project root
          tar -xzf crystal-${{ env.CRYSTAL_VERSION }}-1-darwin-universal.tar.gz

      - name: Download Julia OpenSSL Libraries
        run: |
          # Download Julia OpenSSL binary wrapper for the target architecture
          curl -L -o OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin.tar.gz \
            https://github.com/JuliaBinaryWrappers/OpenSSL_jll.jl/releases/download/OpenSSL-v${{ env.OPENSSL_VERSION }}+0/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin.tar.gz

      - name: Set Up Local Toolchain
        run: |
          # Create local bin directory
          mkdir -p bin

          # Create symlinks to tools
          ln -s ../crystal-${{ env.CRYSTAL_VERSION }}-1/bin/crystal bin/crystal
          ln -s $(brew --prefix)/bin/shards bin/shards
          ln -s $(brew --prefix)/bin/pkg-config bin/pkg-config

      - name: Checkout Coverage Reporter
        uses: actions/checkout@v4
        with:
          repository: coverallsapp/coverage-reporter
          ref: ${{ github.event.inputs.upstream_version }}
          path: coverage-reporter

      - name: Install Coverage Reporter Dependencies
        run: |
          cd coverage-reporter

          # Install production dependencies
          PATH=../bin:$PATH ../bin/shards install --production

      - name: Extract OpenSSL to Distribution Folder
        run: |
          cd coverage-reporter

          # Extract OpenSSL libraries directly into the dist folder
          mkdir -p dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin
          tar -xzf ../OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin.tar.gz -C dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin

          # Copy system CA certificates for SSL verification
          mkdir -p dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/ssl
          if [ -f /etc/ssl/cert.pem ]; then
            cp /etc/ssl/cert.pem dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/ssl/
            echo "Copied system CA certificates"
          else
            echo "Warning: System CA certificates not found at /etc/ssl/cert.pem"
          fi

      - name: Build Binary with Embedded Library Path
        run: |
          cd coverage-reporter

          # Create OpenSSL configuration that points to bundled CA certificates
          cat > dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/ssl/openssl.cnf << 'EOF'
          # OpenSSL configuration for coveralls binary
          openssl_conf = openssl_init

          [openssl_init]
          ssl_conf = ssl_sect

          [ssl_sect]
          system_default = system_default_sect

          [system_default_sect]
          CipherString = DEFAULT@SECLEVEL=1
          MinProtocol = TLSv1.2
          EOF

          # Set CA file path if available
          if [ -f "dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/ssl/cert.pem" ]; then
            echo "CAfile = @executable_path/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/ssl/cert.pem" >> dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/ssl/openssl.cnf
          fi

          # Build with Crystal's embedded libraries and Julia OpenSSL, setting rpath for portability
          PATH=../bin:/bin:/usr/bin \
          PKG_CONFIG_PATH="$PWD/../crystal-${{ env.CRYSTAL_VERSION }}-1/embedded/lib/pkgconfig:$PWD/dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib/pkgconfig" \
          LIBRARY_PATH="$PWD/dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib" \
          ../bin/crystal build src/cli.cr -o dist/coveralls --release --no-debug --progress \
          --link-flags "-Wl,-rpath,@executable_path/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib"

      - name: Test Binary
        run: |
          cd coverage-reporter

          # Test the distributable binary
          ./dist/coveralls --version

          # Verify library dependencies
          echo "Library dependencies:"
          otool -L ./dist/coveralls

          # Verify rpath is set correctly
          echo "Runtime paths:"
          otool -l ./dist/coveralls | grep -A 2 LC_RPATH

      - name: Run Spec Tests
        run: |
          # Create virtual environment and install coverage for spec tests that require it in PATH
          python3 -m venv venv
          source venv/bin/activate
          pip install coverage pytest

          cd coverage-reporter

          # Install development dependencies for testing
          PATH=$PWD/../bin:$PATH ../bin/shards install

          # Run the Crystal spec tests
          PATH=$PWD/../venv/bin:$PWD/../bin:$PATH \
          PKG_CONFIG_PATH="$PWD/../crystal-${{ env.CRYSTAL_VERSION }}-1/embedded/lib/pkgconfig:$PWD/dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib/pkgconfig" \
          LIBRARY_PATH="$PWD/dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib" \
          ../bin/crystal spec --order random --error-on-warnings \
          --link-flags "-Wl,-rpath,@executable_path/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib -Wl,-rpath,$PWD/dist/OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin/lib"

      - name: Create Distribution Package
        run: |
          cd coverage-reporter

          # Create a tarball of the distributable folder directly in parent directory
          tar -czf "../coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}.tar.gz" \
            -C dist .

          # Create shasum files
          cd ..

          # Checksum for the distribution package
          shasum -a 256 "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}.tar.gz" > \
            "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}.tar.gz.sha256"

          # Create build inputs checksums with filenames
          echo "# Build Input Checksums for coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}" > "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          echo "# Generated: $(date -u)" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          echo "# Upstream Version: ${{ github.event.inputs.upstream_version }}" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          echo "# Build Architecture: ${{ matrix.arch }}" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          echo "" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"

          # Add Crystal compiler tarball with filename
          echo "# Crystal Compiler (darwin-universal)" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          shasum -a 256 crystal-${{ env.CRYSTAL_VERSION }}-1-darwin-universal.tar.gz >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          echo "" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"

          # Add Julia OpenSSL tarball with filename
          echo "# Julia OpenSSL Libraries (${{ matrix.arch }}-apple-darwin)" >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"
          shasum -a 256 OpenSSL.v${{ env.OPENSSL_VERSION }}.${{ matrix.arch }}-apple-darwin.tar.gz >> "coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}
          path: |
            coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}.tar.gz
            coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}.tar.gz.sha256
            coveralls-macos-${{ github.event.inputs.upstream_version }}-${{ matrix.artifact_suffix }}-build-inputs.sha256
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Generate release tag
        id: release_info
        run: |
          # Generate build counter
          BUILD_COUNTER=$(date +%Y%m%d%H%M%S)
          RELEASE_TAG="${{ github.event.inputs.upstream_version }}-build.${BUILD_COUNTER}"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release files
        run: |
          # Create release directory
          mkdir -p release-files

          # Copy all files from artifact directories to release directory
          find artifacts -name "*.tar.gz" -exec cp {} release-files/ \;
          find artifacts -name "*.sha256" -exec cp {} release-files/ \;

          # List what we have
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.release_tag }}
          name: "Coveralls macOS Binary ${{ steps.release_info.outputs.release_tag }}"
          body: |
            ## Coveralls Coverage Reporter - macOS Binary Distribution

            Built from upstream version: **${{ github.event.inputs.upstream_version }}**

            ### Build Components
            - **Crystal Compiler**: ${{ env.CRYSTAL_VERSION }} (darwin-universal)
            - **OpenSSL Libraries**: ${{ env.OPENSSL_VERSION }} (Julia BinaryWrappers)
            - **Build Architectures**: aarch64 (Apple Silicon) and x86_64 (Intel)

            ### Features
            - ✅ Completely self-contained - no external dependencies
            - ✅ Uses only system libraries + bundled Julia OpenSSL ${{ env.OPENSSL_VERSION }}
            - ✅ Embedded rpath - works immediately after extraction
            - ✅ True portability - runs on any macOS system

            ### ⚠️ Download Warning
            **IMPORTANT**: Always download the binary using `curl` or `wget`. Never use Safari or other browsers, as they will apply Gatekeeper quarantine attributes that prevent the binary from running.

            ```bash
            # Download with curl (recommended)
            curl -L -O https://github.com/.../coveralls-macos-${{ github.event.inputs.upstream_version }}-aarch64.tar.gz
            curl -L -O https://github.com/.../coveralls-macos-${{ github.event.inputs.upstream_version }}-x86_64.tar.gz

            # Or download with wget
            wget https://github.com/.../coveralls-macos-${{ github.event.inputs.upstream_version }}-aarch64.tar.gz
            wget https://github.com/.../coveralls-macos-${{ github.event.inputs.upstream_version }}-x86_64.tar.gz
            ```

            **Alternative**: But if you did download with Safari, you can remove the quarantine attributes (treat this like you would rm -rf and make sure you type <path> correctly!):
            ```bash
            # Remove quarantine attributes from all downloaded files or all extracted contents:
            find <path> -print -exec xattr -d com.apple.quarantine {} \;
            ```

            ### Usage
            ```bash
            # Choose the appropriate architecture
            # For Apple Silicon (M1/M2/M3): aarch64
            # For Intel Macs: x86_64

            # Verify integrity (optional)
            shasum -a 256 -c coveralls-macos-${{ github.event.inputs.upstream_version }}-aarch64.tar.gz.sha256

            # View build input checksums (optional)
            cat coveralls-macos-${{ github.event.inputs.upstream_version }}-aarch64-build-inputs.sha256

            # Extract the archive
            tar -xzf coveralls-macos-${{ github.event.inputs.upstream_version }}-aarch64.tar.gz
            cd coveralls-macos

            # Run immediately - no setup required!
            ./coveralls --version
            ./coveralls --help
            ```

            ### Build Reproducibility
            The build inputs checksum files contain SHA-256 hashes of:
            - Crystal ${{ env.CRYSTAL_VERSION }} darwin-universal tarball
            - Julia OpenSSL ${{ env.OPENSSL_VERSION }} architecture-specific tarballs

            This enables verification and reproduction of the exact build environment.

            ### Library Dependencies
            - `/usr/lib/libxml2.2.dylib` (system library)
            - `/usr/lib/libz.1.dylib` (system library)
            - `@rpath/libssl.3.dylib` (bundled Julia OpenSSL ${{ env.OPENSSL_VERSION }})
            - `@rpath/libcrypto.3.dylib` (bundled Julia OpenSSL ${{ env.OPENSSL_VERSION }})
            - `/usr/lib/libiconv.2.dylib` (system library)
            - `/usr/lib/libSystem.B.dylib` (system library)

            Built with Crystal ${{ env.CRYSTAL_VERSION }} using our portable build process.
          files: release-files/*
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

